---
# ===============================
# Install RKE2 (OFFLINE)
# ===============================

- name: Ensure required directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /var/lib/rancher/rke2
    - /var/lib/rancher/rke2/agent
    - /var/lib/rancher/rke2/agent/images
    - /etc/rancher/rke2

# -------------------------------
# Copy & install RKE2 binary
# -------------------------------

- name: Copy RKE2 binary tarball
  copy:
    src: rke2.linux-amd64.tar.gz
    dest: /tmp/rke2.linux-amd64.tar.gz
    mode: "0644"

- name: Extract RKE2 binary
  unarchive:
    src: /tmp/rke2.linux-amd64.tar.gz
    dest: /usr/local
    remote_src: yes

# -------------------------------
# Copy RKE2 images (OFFLINE)
# -------------------------------

- name: Copy RKE2 images tarball
  copy:
    src: rke2-images.linux-amd64.tar.zst
    dest: /var/lib/rancher/rke2/agent/images/rke2-images.linux-amd64.tar.zst
    mode: "0644"

# -------------------------------
# Install systemd service
# -------------------------------

- name: Install rke2-server systemd service
  copy:
    src: rke2-server.service
    dest: /etc/systemd/system/rke2-server.service
    mode: "0644"

- name: Reload systemd
  command: systemctl daemon-reload
  changed_when: false
